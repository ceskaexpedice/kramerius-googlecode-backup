#summary Popis instalace a nastavení K4

=  Systémové komponenty =

  * JDK 1.6
  * Apache Tomcat 6
  * Postgres 8, vytvořit uživatele fedoraAdmin a databáze fedora3 a kramerius4

Je vhodné K4 nainstalovat pod samostatným uživatelským účtem, například kramerius4. 

Nastavit potřebné systémové proměnné (předpokládáme instalaci Tomcatu a Fedory do domácího adresáře uživatele kramerius4):
{{{
export JAVA_HOME=/usr/java/jre1.6.0_20
export CATALINA_HOME=$HOME/tomcat
export FEDORA_HOME=$HOME/fedora
export JAVA_OPTS=" -Djava.awt.headless=true  -Dsolr.solr.home=$FEDORA_HOME/solr -XX:MaxPermSize=128m -Xms512m -Xmx1024m" 
export PATH=$PATH:$FEDORA_HOME/server/bin:$FEDORA_HOME/client/bin:$CATALINA_HOME/bin:$JAVA_HOME/bin 
}}}

= Instalace fedory =

Nainstalujte repository Fedora 3.3 pomocí instalátoru fcrepo-installer-3.3.jar. Následuje výpis odpovědí na otázky instalátoru, volby odlišné od defaultních jsou označeny *****

{{{
Installation type: custom  ******

Fedora home: default (/usr/local/fedora)

admin password: fedoraAdmin  ******

Fedora server: default (localhost)

Fedora context: default (fedora)

API-A authentication: default (false)

SSL availability: default (true)

API-A SSL required: default (false)

API-M SSL required: false ******

Servlet engine: existingTomcat  ********

Tomcat home directory: default  (CATALINA_HOME)

Tomcat HTTP port: default (8080)

Tomcat shutdown port: default (8005)

Tomcat secure HTTP port: default (8443)

Keystore file: included *****

Database: postgresql   ******

JDBC driver : default (included)

Database username: fedoraAdmin

Database password: fedoraAdmin

Database URL: default (localhost/fedora3)

JDBC driver: default 

Enable FESL:  default  (false)

Policy enforcement enabled: default (true)

Enable resource index: true  *********

Enable messaging : default (false)

Deploy local services: default (true)
}}}

Po instalaci fedory je třeba do souboru fedora.fcfg do sekce module: resource index přidat následující parametry:

{{{
 <param name="alias:kramerius" value="http://www.nsdl.org/ontologies/relationships#">
      <comment>Alias for Kramerius</comment>
 </param>
 <param name="alias:oai" value="http://www.openarchives.org/OAI/2.0/">
      <comment>Alias for OAI</comment>
 </param>
}}}


Přes administrátorské rozhraní fedory je třeba naimportovat FOXML objekty obsažené v SVN K4 v modulu installation/fedora (https://kramerius.googlecode.com/svn/trunk/installation/fedora). *Před importem je nutné provést konfiguraci [#Fedora_model OAI Fedora modelu].*

= Instalace Apache SOLR =

Do tomcat/webapps nakopírovat solr.war

Do adresáře $FEDORA_HOME/solr nakopírovat obsah modulu z SVN K4 installation/solr
(https://kramerius.googlecode.com/svn/trunk/installation/solr)

editovat solrconfig.xml - položka solr data home

= Instalace K4 =

Do tomcat/webapps nakopírovat search.war

do tomcat-users.xml přidat uživatele s rolí krameriusAdmin:
{{{
 <role rolename="krameriusAdmin"/>
 <user username="kramerius" password="bflmpsvz" roles="krameriusAdmin"/> 
}}}


do context.xml přidat definici datasource: 
{{{
<Resource name="jdbc/kramerius4" auth="Container" type="javax.sql.DataSource"
        initialSize="3"
        maxActive="100" maxIdle="30" maxWait="10000"
        username=“fedoraAdmin” password=“fedoraAdmin” driverClassName="org.postgresql.Driver"
        url="jdbc:postgresql://localhost/kramerius4"/>
}}}

do tomcat/lib překopírovat následující jary z webapps/fedora/WEB-INF/lib:
  * carol
  * commons-logging
  * log4j
  * postgres


do server.xml přidat URIEncoding:
{{{
 <Connector port="8080" protocol="HTTP/1.1" 
               connectionTimeout="20000" URIEncoding="UTF-8"
               redirectPort="8443" />
}}}

Spustit tomcat pod uživatelem kramerius4. V domovském adresáři uživatele kramerius4 je vytvořen adresář .kramerius4 a v něm prázdné soubory configuration.properties, indexer.properties a migration.properties. Popis viz [Konfigurace].

= Instalace OAI =

== Fedora model ==

V `service_ESEDep.xml` a `model_repository.xml` (https://kramerius.googlecode.com/svn/trunk/installation/fedora) opravit všechny `FIXME`.

== PostgreSQL ==

Vytvořit uživatele `proai` a databázi `proai`.

== Tomcat ==

Do `tomcat/webapps` nakopírovat `oaiprovider.war` z SVN K4 (https://kramerius.googlecode.com/svn/trunk/installation/oai).

Editovat `tomcat/webapps/oaiprovider/oaiprovider/WEB-INF/classes/proai.properties`.
{{{
# /tmp/proai obsahuje exportovaná data a nesmí být mazán bez úpravy proai databáze
proai.cacheBaseDir = /tmp/proai/cache
proai.sessionBaseDir = /tmp/proai/sessions
proai.schemaDir = /tmp/proai/schemas

# nahradit všechny odkazy 'localhost' skutečným serverem

# v případě potřeby změnit přístupová jména a hesla podle skutečnosti
proai.db.url = jdbc:postgresql://localhost/proai
proai.db.username = proai
proai.db.password = ********
driver.fedora.user = fedoraAdmin
driver.fedora.pass = ********
driver.fedora.mpt.jdbc.user = fedoraAdmin
driver.fedora.mpt.jdbc.password = ********

# povolit export dat z Fedory
proai.driverPollingEnabled = true
}}}