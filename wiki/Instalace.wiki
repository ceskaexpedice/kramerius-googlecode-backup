#summary Popis instalace a nastavení K4
<wiki:toc max_depth="1" />

Před instalací aplikace Kramerius 4 je třeba nainstalovat následující systémové komponenty:

|| Java || JDK 1.6||
|| Aplikační server|| podporující specifikace Servlet 2.5 a JSP 2.1 nebo novější (popsaná ukázková instalace předpokládá použití Apache Tomcat 6)||
|| Databáze||Postgres 8.4 nebo novější||
||Úložiště||Fedora Commons 3.3, 3.4 nebo 3.5|| 

Kramerius 4 nevyžaduje žádné specifické revize uvedených komponent, obecně je rozumné používat jejich pokud možno nejnovější aktualizace. Popis instalace a administrace těchto systémových komponent není součástí této dokumentace, předpokládáme, že administrátor aplikace Kramerius 4 ovládá instalaci a administraci výše uvedených komponent.

Operační systém může být libovolný, na kterém je možno tyto komponenty provozovat, vlastní aplikace Kramerius 4 žádné speciální požadavky na systém nemá. Hardware serveru musí být dimenzován na uvažované množství dat, doporučujeme minimálně dvojnásobnou velikost pevného disku, než je plánovaná velikost obrazových dat. Vzhledem k velké paměťové náročnosti práce s grafickými daty (náhledy stránek, zoomování) je třeba i při minimálním provozu aplikace alespoň 4GB RAM. 

K4 je vhodné nainstalovat pod samostatným uživatelským účtem, například kramerius4.

V produkčním prostředí je před J2EE server (Tomcat) vhodné předřadit webserver přístupný na portu 80, například Apache s nakonfigurovanými moduly mod_proxy a mod_proxy_ajp.

Každou komponentu systému Kramerius (tedy repository Fedora, vlastní aplikaci K4, indexer SOLR, databázi PostgreSQL)  je možné nainstalovat na samostatný server.  


V následujících odstavcích jsou uvedeny požadavky aplikace Kramerius 4 na specifickou konfiguraci systémových komponent, pokud možno i s odkazy na příklady konkrétních úprav příslušných konfiguračních souborů. Tyto příklady jsou uvedeny pouze pro ilustraci jedné z možných konfigurací a nenahrazují dokumentaci k jednotlivým systémovým komponentám. V případě distribuované instalace je třeba uvedené příklady konfiguračních URL (localhost) nahradit adresami příslušných serverů. 

=Operační systém=

  * Nastavit systémovou proměnnou pro instalaci Fedora Commons( `FEDORA_HOME`).
  * Nastavit dodatečné spouštěcí parametry pro aplikační server : `-Djava.awt.headless=true  -Dsolr.solr.home=$FEDORA_HOME/solr -XX:MaxPermSize=128m -Xms512m -Xmx1024m` 


[PrikladKonfigurace#System_Variables Příklad konfigurace systémových proměnných]

(v uvedených příkladech konfigurace předpokládáme instalaci Tomcatu a Fedory do domácího adresáře uživatele kramerius4)

=PostgreSQL=

  * Vytvořit uživatele `fedoraAdmin` a pro něj databáze `fedora3`, `kramerius4` a (při použití implementace Fedora Resource Indexu MPTTripleStore) `riTriples`.


= Fedora Commons =

Nainstalujte úložiště Fedora Commons podle jeho dokumentace.

[PrikladKonfigurace#Fedora Příklad instalace Fedora Commons]

==Nastavení aliasů==

Po instalaci fedory je třeba do souboru `$FEDORA_HOME/server/config/fedora.fcfg` do sekce začínající `<module role="fedora.server.resourceIndex.ResourceIndex" ` přidat následující parametry (definice aliasů pro XML namespace):

{{{
 <param name="alias:kramerius" value="http://www.nsdl.org/ontologies/relationships#">
      <comment>Alias for Kramerius</comment>
 </param>
 <param name="alias:oai" value="http://www.openarchives.org/OAI/2.0/">
      <comment>Alias for OAI</comment>
 </param>
}}}

==Nastavení implementace resource indexu==

Ve stejné sekci fedora.fcfg, jako pro nastavení aliasů (resource index) je třeba změnit u parametru `datastore` hodnotu na `localPostgresMPTTriplestore`. V odpovídající sekci localPostgresMPTTriplestore, kde je definován datasource pro MPTTriplesotre, je třeba nastavit databázové heslo na heslo, které jste přiřadili uživateli fedoraAdmin. 

_(Poznámka: Kramerius 4 podporuje implementaci Resource index Mulgara i MPTtripleStore. To, která implementace bude použita, je určeno konfigurační property `resource.index.service.class` v souboru `configuration.properties` - viz níže. Výchozí hodnota této property je nastavena na MPTtripleStore, protože implementace Mulgara není v současné podobě použitelná se službou OAI provider. )_

==Nastavení přístupových práv==

Aplikace Kramerius 4 má vlastní systém řízení přístupových práv a nevyužívá systém XACML pravidel Fedora Commons. Pokud nepotřebujete k úložišti přistupovat odjinud, než z aplikace Kramerius 4, je tedy nejjednodušší úložiště vůbec nezveřejňovat a systém pravidel XACML nevyužívat. Deaktivace autorizačního systému je popsána v dokumentaci Fedora Commons, jednou z možností je v souboru fedora.fcfg v sekci `<module role="org.fcrepo.server.security.Authorization"` nastavit parametr `<param name="ENFORCE-MODE" value="permit-all-requests"/>`.

Jestliže z nějakého důvodu autorizační systém Fedora Commons potřebujete používat, je pravděpodobné, že narazíte na následující situace:

  * Pokud k administrátorskému rozhraní Fedory chcete přistupovat z jiného počítače, než na kterém je nainstalovaná, musíte deaktivovat nebo upravit omezení přístupu ` deny-apim-if-not-localhost.xml`

  * Při použití FOXML objektů s externě referencovaným obsahem datastreamů je třeba  deaktivovat nebo upravit pravidlo `deny-unallowed-file-resolution.xml`

XACML pravidla jsou uložena ve složce `$FEDORA_HOME/data/fedora-xacml-policies/repository-policies`. Deaktivaci lze provést buď editací xacml pravidel v souboru nebo jeho prostým odstraněním. Editace xacml pravidel je popsána v dokumentaci úložiště Fedora Commons.

==Import FOXML modelů==

Přes administrátorské rozhraní Fedory je třeba naimportovat FOXML objekty obsažené v distribučním souboru  installation-x.x.zip, adresář `fedora`. _Pokud budete importovat i [#Fedora_model OAI Fedora model], je před jeho importem nutné provést konfiguraci ._ Popis administrátorského rozhraní je součástí dokumentace Fedora Commons.

= Instalace Apache SOLR =

Na aplikační server nainstalovat aplikaci `solr.war` z distribučního souboru installation-x.x.zip.

Do adresáře $FEDORA_HOME/solr nakopírovat obsah adresáře `solr`  z distribučního souboru installation-x.x.zip.

V adresáři  $FEDORA_HOME/solr/conf editovat soubor solrconfig.xml - položka `dataDir`

= Instalace K4 =

Na aplikační server nainstalovat aplikace search.war, editor.war a rightseditor.war z distribučního souboru Kramerius-x.x.zip.

==Konfigurace datasource==

V aplikačním serveru nakonfigurujte JDBC datasource pro databázi `kramerius4` ( [PrikladKonfigurace#Konfigurace_datasource příklad pro Tomcat]). 

Do adresáře sdílených knihoven aplikačního serveru (v případě Tomcatu `tomcat/lib`) přidejte jar soubor s JDBC ovladačem pro PostgreSQL, který je součástí instalace vašeho databázového serveru.

==Instalace sdílených knihoven==

Pokud instalujete aplikaci K4 na stejnou instanci aplikačního serveru, na kterém je nainstalováno úložiště Fedora Commons, je třeba do adresáře sdílených knihoven aplikačního serveru (v případě Tomcatu `tomcat/lib`) překopírovat následující knihovní soubory jar z aplikace fedora (v případě Tomcatu adresář `webapps/fedora/WEB-INF/lib`):
  * `carol`
  * `commons-logging`  (pro Fedora Commons 3.4 a novější již není třeba)
  * `log4j` (pro Fedora Commons 3.4 a novější již není třeba)

==Nastavení kódování URI==

V aplikačním serveru nastavte kódování URI na UTF-8  ([PrikladKonfigurace#URIEncoding příklad pro Tomcat])

==Single Sign-on==

Pokud chcete pro všechny 3 webové aplikace systému Kramerius4 (tedy hlavní `search` a administrátorské `editor` a `rightseditor`) používat jednotné přihlášení uživatele, nastavte tuto možnost v konfiguraci aplikačního serveru  ([PrikladKonfigurace#Single_Sign-on příklad pro Tomcat])


= Konfigurace =

Po prvním spuštění aplikačního serveru s nainstalovanou aplikací Kramerius 4 (pod systémovým uživatelem kramerius4) je v domovském adresáři uživatele kramerius4 vytvořen adresář `.kramerius4` a v něm prázdné soubory `configuration.properties`, `search.properties`, `indexer.properties` a `migration.properties`. Konfigurační soubory K4 využívají rozšířené syntaxe properties podporované použitou knihovnou Apache commons-configuration.  Soubory jsou uspořádány ve dvoustupňové hierarchii: Základní sdílené properties jsou v souboru configuration.properties, jednotlivé plugin moduly externích procesů je pak rozšiřují ve svých konfiguračních souborech (např. migration.properties, indexer.properties). Konfigurační properties specifické pro GUI K4 jsou v souboru search.properties.

Defaultní hodnoty properties (viz níže) jsou definovány uvnitř aplikačního archivu search.war. Hodnoty je možno předefinovat jejich uvedením ve stejně pojmenovaném souboru umístěném v adresáři $USER_HOME/.kramerius4. Tyto konfigurační soubory (prázdné) jsou vytvořeny automaticky při prvním spuštění K4, resp. příslušného externího procesu.

Obsah defaultních hodnot jednotlivých konfiguračních souborů najdete zde:

  * [http://code.google.com/p/kramerius/source/browse/trunk/common/src/main/java/res/configuration.properties configuration.properties]
  * [http://code.google.com/p/kramerius/source/browse/trunk/search/src/java/res/configuration.properties search.properties]
  * [http://code.google.com/p/kramerius/source/browse/trunk/indexer/src/res/configuration.properties  indexer.properties]
  * [http://code.google.com/p/kramerius/source/browse/trunk/import-cmdtool/src/main/java/res/configuration.properties  migration.properties]


=Podpora protokolu deepZoom=
Kromě standardního zobrazení obrázků má aplikace kramerius4 možnost prezentovat je pomocí prohlížečky seadragon(http://www.zoom.it). V tomto případě je zapotřebí krameria nakonfiguruovat. Jsou dvě možnosti: 

 * Využít produkt IIP server (http://iipimage.sourceforge.net).

Zde slouží kramerius jako prostředník. Klientské dotazy na jednotlivé dlaždice přeposílá IIP serveru a sám se stará pouze o autorizaci požadavku. Konfigurace adresy serveru pro dlaždice je uložena v metadatech ve streamu RELS-EXT. Konkrétně se jedná o  literál 
<kramerius4:tiles-url>. Hodnotou literálu je přímo URL na zoomovaný obrázek. 

Příklady definic v RELS-EXT:

<kramerius4:tiles-url>http://192.168.1.1/fcgi-bin/iipsrv.fcgi?DeepZoom=/mzk03/001/042/654/2619265924.jp2</kramerius4:tiles>

<kramerius4:tiles-url>http://imageserver.mzk.cz/mzk03/001/066/607/2619320306/1</kramerius4:tiles-url>

Pokud je obrázek ve fedoře uložen jako "Managed Content Stream"  je potřeba do URL dopropagovat fyzickou adresu souboru. Kramerius 4 umožňuje získat relativní adresu streamu pomocí interpretované proměnné $internalstream$,která může být přímo součástí URL adresy. Adresa je raltivní vůči kořenovému adresáři fedory, kde fedora uchovává data. Standardně se tento kořenový adresář nachází $FEDORA_HOME$/data

Příklad definice v RELS-EXT: 

<kramerius4:tiles-url>http://192.168.1.1/fcgi-bin/iipsrv.fcgi?DeepZoom=/mnt/fedora_data_folder/$internalstream$</kramerius4:tiles-url>

Pozn.: Předpokládá se, že IIP server má datový adresář fedory připojený jako /mnt/fedora_data_folder/


 * Systémem kramerius si vygenerovat soubory do interní cache.
V tomto případě je nutné mít v literálu kramerius4:tiles-url mít uvedenou konstantu 
kramerius4://deepZoomCache. 

Příklad:

<kramerius4:tiles-url>kramerius4://deepZoomCache</kramerius4:tiles-url>

Pozn. Je samozřejmě nutné cache naplnit a to akcí "Generování Deep Zoom Cache...".  


==Verze IIP serveru==

Standardní IIP server rozeznává typy souborů dle koncovky. Aby mohl podávat soubory, které nemají koncovky (např. datastreamy z fedory) bylo potřeba udělat zásah do serveru.  Pozměněnou verzi IIP serveru je možné najít zde: 

http://iris.mzk.cz/iipimage.tar.bz2 



=Přístupová práva uživatelů=

Kramerius 4 používá od verze 4.2 nový systém správy uživatelů a přístupových práv. Jeho principy a administrace jsou popsány v dokumentu [Prava Správa uživatelů]

==Instalace==

===tomcat===

do lib přidat security-core.jar
do webapps nainstalovat aplikaci rightseditor.war
povolit single sign on v server.xml 

{{{
<Valve className="org.apache.catalina.authenticator.SingleSignOn" />
}}}

do conf/Catalina/localhost přidat soubory search.xml a rightseditor.xml s tímto obsahem

{{{
<Context>
	<Realm className="org.apache.catalina.realm.JAASRealm"                 
		appName="search"       
		userClassNames="cz.incad.kramerius.security.jaas.K4UserPrincipal"       
		roleClassNames="cz.incad.kramerius.security.jaas.K4RolePrincipal"
		debug="99"/>
</Context>
}}}

===fedora===

do server/config/jaas.conf přidat:
{{{
search {
 cz.incad.kramerius.security.jaas.K4LoginModule required debug=true;
};


rightseditor {
 cz.incad.kramerius.security.jaas.K4LoginModule required debug=true;
};
}}}


===Kramerius4===

do .kramerius4 přidat mail.properties s obsahem:

{{{
# Mail properties bez SSL
mail.smtp.user=hudlibudli@gmail.com
mail.smtp.pass=blablabla
mail.smtp.host=smtp.gmail.com
mail.smtp.port=25
}}}

nebo 

{{{
# Mail properties s podporou SSL
mail.smtp.user=hudlibudli@gmail.com
mail.smtp.pass=blablabla
mail.smtp.host=smtp.gmail.com
mail.smtp.port=465
mail.smtp.starttls.enable=true
mail.smtp.auth=true
mail.smtp.socketFactory.port=465
mail.smtp.socketFactory.class=javax.net.ssl.SSLSocketFactory
mail.smtp.socketFactory.fallback=false
}}}


Po prvním spuštění aplikace se v databázi vytvoří databázové tabulky s předdefinovanými pravidly a implicitnim admin uživatelem.  Nastaveni pravidel odpovídá dosavadním verzím K4 a předdefinované jméno a heslo admin uživatele je: 

krameriusAdmin 

krameriusAdmin

=Editor pořadí částí dokumentu (RELS-EXT)=

Editor se instaluje jako samostatná webová aplikace nakopírováním souboru editor.war do složky webapps v Tomcatu.

Před spuštěním je potřeba mít nakonfigurován single-sign-on (viz Přístupová práva).

Kramerius 4 umožňuje nahradit tento výchozí editor jiným editorem. To, který editor se spustí z kontextového menu v GUI K4, je určeno položkou editorUrl v configuration.properties:

{{{
editorUrl=${_fedoraTomcatHost}/editor
}}}

Volané url z kontextového menu má například takovýto tvar: 
{{{
http://localhost:8080/editor/?openIDs=uuid:0eaa6730-9068-11dd-97de-000d606f5dc6&locale=en
}}}  



= Instalace OAI =

== Fedora model ==

V `service_ESEDep.xml` a `model_repository.xml` (https://kramerius.googlecode.com/svn/trunk/installation/fedora) opravit všechny `FIXME`.

== PostgreSQL ==

Vytvořit uživatele `proai` a databázi `proai`.

== Tomcat ==

Do `tomcat/webapps` nakopírovat `oaiprovider.war` z SVN K4 (https://kramerius.googlecode.com/svn/trunk/installation/oai).

Editovat `tomcat/webapps/oaiprovider/WEB-INF/classes/proai.properties`.
{{{
# /tmp/proai obsahuje exportovaná data a nesmí být mazán bez úpravy proai databáze
proai.cacheBaseDir = /tmp/proai/cache
proai.sessionBaseDir = /tmp/proai/sessions
proai.schemaDir = /tmp/proai/schemas

# nahradit všechny odkazy 'localhost' skutečným serverem

# v případě potřeby změnit přístupová jména a hesla podle skutečnosti
proai.db.url = jdbc:postgresql://localhost/proai
proai.db.username = proai
proai.db.password = ********
driver.fedora.user = fedoraAdmin
driver.fedora.pass = ********
driver.fedora.mpt.jdbc.user = fedoraAdmin
driver.fedora.mpt.jdbc.password = ********

# povolit export dat z Fedory
proai.driverPollingEnabled = true
}}}